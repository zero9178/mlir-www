<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>MLIR Reduce - MLIR</title><meta name=description content="Multi-Level IR Compiler Framework"><meta name=generator content="Hugo 0.80.0"><link href=https://mlir.llvm.org/index.xml rel=alternate type=application/rss+xml><link rel=canonical href=https://mlir.llvm.org/docs/Tools/mlir-reduce/><link rel=stylesheet href=https://mlir.llvm.org/css/theme.css><script src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script><link rel=stylesheet href=https://mlir.llvm.org/css/chroma.min.css><script src=https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js></script><script src=https://cdn.jsdelivr.net/npm/jquery.easing@1.4.1/jquery.easing.min.js></script><script src=https://mlir.llvm.org/js/bundle.js></script><script type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type=text/x-mathjax-config>
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$', '$'] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
    }
  });
</script><link rel=apple-touch-icon sizes=180x180 href="/apple-touch-icon.png?v=1"><link rel=icon type=image/png sizes=32x32 href="/favicon-32x32.png?v=1"><link rel=icon type=image/png sizes=16x16 href="/favicon-16x16.png?v=1"><link rel=manifest href="/site.webmanifest?v=1"><link rel=mask-icon href="/safari-pinned-tab.svg?v=1" color=#3775e0><link rel="shortcut icon" href="/favicon.ico?v=1"><meta name=msapplication-TileColor content="#2d89ef"><meta name=theme-color content="#ffffff"><link rel=icon href=/favicon.svg type=image/svg+xml sizes=any><style>:root{}</style></head><body><div class=container><header><h1><div><img src=https://mlir.llvm.org//mlir-logo.png width=40px align=absmiddle>
MLIR</div></h1><p class=description>Multi-Level IR Compiler Framework</p></header><div class=global-menu><nav><ul><li class=parent><a href>Community<i class="fas fa-angle-right"></i></a><ul class=sub-menu><li class=child><a href=https://llvm.discourse.group/c/mlir/31>Forums</a></li><li class=child><a href=https://discord.gg/xS7Z362>Chat</a></li></ul></li><li><a href=/getting_started/Debugging/>Debugging Tips</a></li><li><a href=/getting_started/Faq/>FAQ</a></li><li class=parent><a href=https://github.com/llvm/llvm-project/tree/main/mlir>Source<i class="fas fa-angle-right"></i></a><ul class=sub-menu><li class=child><a href=/doxygen/>Doxygen</a></li><li class=child><a href=https://github.com/llvm/llvm-project/tree/main/mlir>GitHub</a></li></ul></li><li><a href="https://bugs.llvm.org/buglist.cgi?bug_status=__open__&list_id=177877&order=changeddate%20DESC%2Cpriority%2Cbug_severity&product=MLIR&query_format=specific">Bugs</a></li><li><a href=https://github.com/llvm/mlir-www/tree/main/website/static/LogoAssets>Logo Assets</a></li><li><a href=https://www.youtube.com/MLIRCompiler>Youtube Channel</a></li></ul></nav></div><div class=content-container><main><h1>MLIR Reduce</h1><p><nav id=TableOfContents><ul><li><a href=#how-to-use-it>How to Use it</a><ul><li><a href=#write-the-script-for-testing-interestingness>Write the script for testing interestingness</a></li></ul></li><li><a href=#available-reduction-strategies>Available reduction strategies</a><ul><li><a href=#operation-elimination>Operation elimination</a></li><li><a href=#rewrite-patterns-into-simpler-forms>Rewrite patterns into simpler forms</a></li><li><a href=#reduce-with-built-in-optimization-passes>Reduce with built-in optimization passes</a></li></ul></li><li><a href=#build-a-custom-mlir-reduce>Build a custom mlir-reduce</a></li><li><a href=#future-works>Future works</a></li></ul></nav><p>An MLIR input may trigger bugs after series of transformations. To root cause
the problem or help verification after fixes, developers want to be able to
reduce the size of a reproducer for a bug. This document describes
<code>mlir-reduce</code>, which is similar to
<a href=https://llvm.org/docs/CommandGuide/bugpoint.html>bugpoint</a>, a tool that can
reduce the size of the input needed to trigger the error.</p><p><code>mlir-reduce</code> supports reducing the input in several ways, including simply
deleting code not required to reproduce an error, applying the reducer
patterns heuristically or run with optimization passes to reduce the input. To
use it, the first thing you need to do is, provide a command which tells if an
input is interesting, e.g., exhibits the characteristics that you would like to
focus on. For example, you may want to see if <code>mlir-opt</code> invocation fails after
it runs on the certain MLIR input. Afterwards, select your reduction strategy
then <code>mlir-reduce</code> will do the remaining works for you.</p><h2 id=how-to-use-it>How to Use it&nbsp;<a class=headline-hash href=#how-to-use-it>¶</a></h2><p><code>mlir-reduce</code> adopts the reduction-tree algorithm to reduce the input. It
generates several reduced outputs and further reduces in between them according
to the tree traversal strategy. The different strategies may lead to different
results and different time complexity. You can run as
<code>-reduction-tree='traversal-mode=0'</code> to select the mode for example.</p><h3 id=write-the-script-for-testing-interestingness>Write the script for testing interestingness&nbsp;<a class=headline-hash href=#write-the-script-for-testing-interestingness>¶</a></h3><p>As mentioned, you need to provide a command to <code>mlir-reduce</code> which identifies
cases you&rsquo;re interested in. For each intermediate output generated during
reduction, <code>mlir-reduce</code> will run the command over the it, the script should
returns 1 for interesting case, 0 otherwise. The sample script,</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>mlir-opt -convert-vector-to-spirv <span class=nv>$1</span> <span class=p>|</span> grep <span class=s2>&#34;failed to materialize&#34;</span>
<span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> -eq <span class=m>1</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>else</span>
  <span class=nb>exit</span> <span class=m>0</span>
<span class=k>fi</span>
</code></pre></div><p>The sample usage will be like, note that the <code>test</code> argument is part of the mode
argument.</p><div class=highlight><pre class=chroma><code class=language-shell data-lang=shell>mlir-reduce <span class=nv>$INPUT</span> -reduction-tree<span class=o>=</span><span class=s1>&#39;traversal-mode=0 test=$TEST_SCRIPT&#39;</span>
</code></pre></div><h2 id=available-reduction-strategies>Available reduction strategies&nbsp;<a class=headline-hash href=#available-reduction-strategies>¶</a></h2><h3 id=operation-elimination>Operation elimination&nbsp;<a class=headline-hash href=#operation-elimination>¶</a></h3><p><code>mlir-reduce</code> will try to remove the operations directly. This is the most
aggressive reduction as it may result in an invalid output as long as it ends up
retaining the error message that the test script is interesting. To avoid that,
<code>mlir-reduce</code> always checks the validity and it expects the user will provide a
valid input as well.</p><h3 id=rewrite-patterns-into-simpler-forms>Rewrite patterns into simpler forms&nbsp;<a class=headline-hash href=#rewrite-patterns-into-simpler-forms>¶</a></h3><p>In some cases, rewrite an operation into a simpler or smaller form can still
retain the interestingness. For example, <code>mlir-reduce</code> will try to rewrite a
<code>tensor&lt;?xindex></code> with unknown rank into a constant rank one like
<code>tensor&lt;1xi32></code>. Not only produce a simpler operation, it may introduce further
reduction chances because of precise type information.</p><p>MLIR supports dialects and <code>mlir-reduce</code> supports rewrite patterns for every
dialect as well. Which means you can have the dialect specific rewrite patterns.
To do that, you need to implement the <code>DialectReductionPatternInterface</code>. For
example,</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cp>#include</span> <span class=cpf>&#34;mlir/Reducer/ReductionPatternInterface.h&#34;</span><span class=cp>
</span><span class=cp></span>
<span class=k>struct</span> <span class=nc>MyReductionPatternInterface</span> <span class=o>:</span> <span class=k>public</span> <span class=n>DialectReductionPatternInterface</span> <span class=p>{</span>
  <span class=k>virtual</span> <span class=kt>void</span>
  <span class=nf>populateReductionPatterns</span><span class=p>(</span><span class=n>RewritePatternSet</span> <span class=o>&amp;</span><span class=n>patterns</span><span class=p>)</span> <span class=k>const</span> <span class=k>final</span> <span class=p>{</span>
    <span class=n>populateMyReductionPatterns</span><span class=p>(</span><span class=n>patterns</span><span class=p>);</span>
  <span class=p>}</span>
<span class=p>}</span>
</code></pre></div><p><code>mlir-reduce</code> will call <code>populateReductionPatterns</code> to collect the reduction
rewrite patterns provided by each dialect. Here&rsquo;s a hint, if you use
<a href=/docs/DeclarativeRewrites/>DRR</a> to write the reduction patterns, you can
leverage the method <code>populateWithGenerated</code> generated by <code>mlir-tblgen</code>.</p><h3 id=reduce-with-built-in-optimization-passes>Reduce with built-in optimization passes&nbsp;<a class=headline-hash href=#reduce-with-built-in-optimization-passes>¶</a></h3><p>MLIR provides amount of transformation passes and some of them are useful for
reducing the input size, e.g., Symbol-DCE. <code>mlir-reduce</code> will schedule them
along with above two strategies.</p><h2 id=build-a-custom-mlir-reduce>Build a custom mlir-reduce&nbsp;<a class=headline-hash href=#build-a-custom-mlir-reduce>¶</a></h2><p>In the cases of, 1. have defined a custom syntax, 2. the failure is specific to
certain dialects or 3. there&rsquo;s a dialect specific reducer patterns, you need to
build your own <code>mlir-reduce</code>. Link it with <code>MLIRReduceLib</code> and implement it
like,</p><div class=highlight><pre class=chroma><code class=language-c++ data-lang=c++><span class=cp>#include</span> <span class=cpf>&#34;mlir/Tools/mlir-reduce/MlirReduceMain.h&#34;</span><span class=cp>
</span><span class=cp></span><span class=k>using</span> <span class=k>namespace</span> <span class=n>mlir</span><span class=p>;</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span> <span class=o>**</span><span class=n>argv</span><span class=p>)</span> <span class=p>{</span>
  <span class=n>DialectRegistry</span> <span class=n>registry</span><span class=p>;</span>
  <span class=n>registerMyDialects</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span>
  <span class=c1>// Register the DialectReductionPatternInterface if any.
</span><span class=c1></span>  <span class=n>MLIRContext</span> <span class=n>context</span><span class=p>(</span><span class=n>registry</span><span class=p>);</span>
  <span class=k>return</span> <span class=n>failed</span><span class=p>(</span><span class=n>mlirReduceMain</span><span class=p>(</span><span class=n>argc</span><span class=p>,</span> <span class=n>argv</span><span class=p>,</span> <span class=n>context</span><span class=p>));</span>
<span class=p>}</span>

</code></pre></div><h2 id=future-works>Future works&nbsp;<a class=headline-hash href=#future-works>¶</a></h2><p><code>mlir-reduce</code> is missing several features,</p><ul><li><code>-reduction-tree</code> now only supports <code>Single-Path</code> traversal mode, extends it
with different traversal strategies may reduce the input better.</li><li>Produce the optimal result when interrupted. The reduction process may take
a quite long time, it&rsquo;ll be better to get an optimal result so far while an
interrupt is triggered.</li></ul><div class=edit-meta><br></div><nav class=pagination><a class="nav nav-prev" href=/docs/Tools/MLIRLSP/ title="MLIR : Language Server Protocol"><i class="fas fa-arrow-left" aria-hidden=true></i>Prev - MLIR : Language Server Protocol</a>
<a class="nav nav-next" href=/docs/BufferDeallocationInternals/ title="Buffer Deallocation - Internals">Next - Buffer Deallocation - Internals <i class="fas fa-arrow-right" aria-hidden=true></i></a></nav><footer><p class=powered>Powered by <a href=https://gohugo.io>Hugo</a>. Theme by <a href=https://themes.gohugo.io/hugo-theme-techdoc/>TechDoc</a>. Designed by <a href=https://github.com/thingsym/hugo-theme-techdoc>Thingsym</a>.</p></footer></main><div class=sidebar><nav class=slide-menu><ul><li><a href=https://mlir.llvm.org/>Home</a></li><li><a href=/pubs/>MLIR Related Publications</a></li><li><a href=/talks/>Talks</a></li><li><a href=/users/>Users of MLIR</a></li><li class=has-sub-menu><a href=/getting_started/>Getting Started<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=/getting_started/Debugging/>Debugging Tips</a></li><li><a href=/getting_started/Faq/>FAQ</a></li><li><a href=/getting_started/Contributing/>How to Contribute</a></li><li><a href=/getting_started/DeveloperGuide/>Developer Guide</a></li><li><a href=/getting_started/openprojects/>Open Projects</a></li><li><a href=/getting_started/Glossary/>Glossary</a></li><li><a href=/getting_started/TestingGuide/>Testing Guide</a></li></ul></li><li class="parent has-sub-menu"><a href=/docs/>Code Documentation<span class="mark opened">-</span></a><ul class=sub-menu><li class=has-sub-menu><a href=/docs/Bindings/>Bindings<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=/docs/Bindings/Python/>MLIR Python Bindings</a></li></ul></li><li class="parent has-sub-menu"><a href=/docs/Tools/>Tools<span class="mark opened">-</span></a><ul class=sub-menu><li><a href=/docs/Tools/MLIRLSP/>MLIR : Language Server Protocol</a></li><li class=active><a href=/docs/Tools/mlir-reduce/>MLIR Reduce</a></li></ul></li><li><a href=/docs/BufferDeallocationInternals/>Buffer Deallocation - Internals</a></li><li><a href=/docs/Bufferization/>Bufferization</a></li><li><a href=/docs/DataLayout/>Data Layout Modeling</a></li><li><a href=/docs/DebugActions/>Debug Actions</a></li><li><a href=/docs/AttributesAndTypes/>Defining Dialect Attributes and Types</a></li><li><a href=/docs/DefiningDialects/>Defining Dialects</a></li><li><a href=/docs/Diagnostics/>Diagnostic Infrastructure</a></li><li><a href=/docs/DialectConversion/>Dialect Conversion</a></li><li class=has-sub-menu><a href=/docs/Dialects/>Dialects<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=/docs/Dialects/OpenACCDialect/>'acc' Dialect</a></li><li><a href=/docs/Dialects/Affine/>'affine' Dialect</a></li><li><a href=/docs/Dialects/AMX/>'amx' Dialect</a></li><li><a href=/docs/Dialects/ArithmeticOps/>'arith' Dialect</a></li><li><a href=/docs/Dialects/ArmNeon/>'arm_neon' Dialect</a></li><li><a href=/docs/Dialects/ArmSVE/>'arm_sve' Dialect</a></li><li><a href=/docs/Dialects/AsyncDialect/>'async' Dialect</a></li><li><a href=/docs/Dialects/BufferizationOps/>'bufferization' Dialect</a></li><li><a href=/docs/Dialects/ControlFlowDialect/>'cf' Dialect</a></li><li><a href=/docs/Dialects/ComplexOps/>'complex' Dialect</a></li><li><a href=/docs/Dialects/DLTIDialect/>'dlti' Dialect</a></li><li><a href=/docs/Dialects/EmitC/>'emitc' Dialect</a></li><li><a href=/docs/Dialects/Func/>'func' Dialect</a></li><li><a href=/docs/Dialects/GPU/>'gpu' Dialect</a></li><li class=has-sub-menu><a href=/docs/Dialects/Linalg/>'linalg' Dialect<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=/docs/Dialects/Linalg/OpDSL/>Linalg OpDSL</a></li></ul></li><li><a href=/docs/Dialects/LLVM/>'llvm' Dialect</a></li><li><a href=/docs/Dialects/MathOps/>'math' Dialect</a></li><li><a href=/docs/Dialects/MemRef/>'memref' Dialect</a></li><li><a href=/docs/Dialects/MLProgramOps/>'ml_program' Dialect</a></li><li><a href=/docs/Dialects/NVGPU/>'nvgpu' Dialect</a></li><li><a href=/docs/Dialects/NVVMDialect/>'nvvm' Dialect</a></li><li><a href=/docs/Dialects/OpenMPDialect/>'omp' Dialect</a></li><li><a href=/docs/Dialects/PDLOps/>'pdl' Dialect</a></li><li><a href=/docs/Dialects/PDLInterpOps/>'pdl_interp' Dialect</a></li><li><a href=/docs/Dialects/QuantDialect/>'quant' Dialect</a></li><li><a href=/docs/Dialects/ROCDLDialect/>'rocdl' Dialect</a></li><li><a href=/docs/Dialects/SCFDialect/>'scf' Dialect</a></li><li><a href=/docs/Dialects/ShapeDialect/>'shape' Dialect</a></li><li><a href=/docs/Dialects/SparseTensorOps/>'sparse_tensor' Dialect</a></li><li><a href=/docs/Dialects/SPIR-V/>'spv' Dialect</a></li><li><a href=/docs/Dialects/TensorOps/>'tensor' Dialect</a></li><li><a href=/docs/Dialects/Vector/>'vector' Dialect</a></li><li><a href=/docs/Dialects/X86Vector/>'x86vector' Dialect</a></li><li><a href=/docs/Dialects/Builtin/>Builtin Dialect</a></li><li><a href=/docs/Dialects/TOSA/>Tensor Operator Set Architecture (TOSA) Dialect</a></li><li><a href=/docs/Dialects/Transform/>Transform Dialect</a></li></ul></li><li><a href=/docs/ExtensibleDialects/>Extensible dialects</a></li><li><a href=/docs/Interfaces/>Interfaces</a></li><li><a href=/docs/TargetLLVMIR/>LLVM IR Target</a></li><li><a href=/docs/CAPI/>MLIR C API</a></li><li><a href=/docs/LangRef/>MLIR Language Reference</a></li><li><a href=/docs/Canonicalization/>Operation Canonicalization</a></li><li><a href=/docs/OpDefinitions/>Operation Definition Specification (ODS)</a></li><li><a href=/docs/PassManagement/>Pass Infrastructure</a></li><li><a href=/docs/Passes/>Passes</a></li><li><a href=/docs/PatternRewriter/>Pattern Rewriting : Generic DAG-to-DAG Rewriting</a></li><li><a href=/docs/PDLL/>PDLL - PDL Language</a></li><li><a href=/docs/Quantization/>Quantization</a></li><li class=has-sub-menu><a href=/docs/Rationale/>Rationale<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=/docs/Rationale/RationaleGenericDAGRewriter/>Generic DAG Rewriter Infrastructure Rationale</a></li><li><a href=/docs/Rationale/RationaleLinalgDialect/>Linalg Dialect Rationale: The Case For Compiler-Friendly Custom Operations</a></li><li><a href=/docs/Rationale/Rationale/>MLIR Rationale</a></li><li><a href=/docs/Rationale/MLIRForGraphAlgorithms/>MLIR: Incremental Application to Graph Algorithms in ML Frameworks</a></li><li><a href=/docs/Rationale/RationaleSimplifiedPolyhedralForm/>MLIR: The case for a simplified polyhedral form</a></li><li><a href=/docs/Rationale/UsageOfConst/>Usage of 'const' in MLIR, for core IR types</a></li></ul></li><li><a href=/docs/ShapeInference/>Shape Inference</a></li><li><a href=/docs/SPIRVToLLVMDialectConversion/>SPIR-V Dialect to LLVM Dialect conversion manual</a></li><li><a href=/docs/SymbolsAndSymbolTables/>Symbols and Symbol Tables</a></li><li><a href=/docs/DeclarativeRewrites/>Table-driven Declarative Rewrite Rule (DRR)</a></li><li><a href=/docs/Traits/>Traits</a></li><li class=has-sub-menu><a href=/docs/Tutorials/>Tutorials<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=/docs/Tutorials/CreatingADialect/>Creating a Dialect</a></li><li><a href=/docs/Tutorials/QuickstartRewrites/>Quickstart tutorial to adding MLIR graph rewrite</a></li><li class=has-sub-menu><a href=/docs/Tutorials/Toy/>Toy Tutorial<span class="mark closed">+</span></a><ul class=sub-menu><li><a href=/docs/Tutorials/Toy/Ch-1/>Chapter 1: Toy Language and AST</a></li><li><a href=/docs/Tutorials/Toy/Ch-2/>Chapter 2: Emitting Basic MLIR</a></li><li><a href=/docs/Tutorials/Toy/Ch-3/>Chapter 3: High-level Language-Specific Analysis and Transformation</a></li><li><a href=/docs/Tutorials/Toy/Ch-4/>Chapter 4: Enabling Generic Transformation with Interfaces</a></li><li><a href=/docs/Tutorials/Toy/Ch-5/>Chapter 5: Partial Lowering to Lower-Level Dialects for Optimization</a></li><li><a href=/docs/Tutorials/Toy/Ch-6/>Chapter 6: Lowering to LLVM and CodeGeneration</a></li><li><a href=/docs/Tutorials/Toy/Ch-7/>Chapter 7: Adding a Composite Type to Toy</a></li></ul></li><li><a href=/docs/Tutorials/UnderstandingTheIRStructure/>Understanding the IR Structure</a></li><li><a href=/docs/Tutorials/DataFlowAnalysis/>Writing DataFlow Analyses in MLIR</a></li></ul></li></ul></li></ul></nav><div class=sidebar-footer></div></div></div><a href=# id=backtothetop-fixed class=backtothetop data-backtothetop-duration=600 data-backtothetop-easing=easeOutQuart data-backtothetop-fixed-fadein=1000 data-backtothetop-fixed-fadeout=1000 data-backtothetop-fixed-bottom=10 data-backtothetop-fixed-right=20><span class="fa-layers fa-fw"><i class="fas fa-circle"></i><i class="fas fa-arrow-circle-up"></i></span></a></div></body></html>